<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wizarding World Itinerary</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Lato', sans-serif;
            background-color: #1a1a1a;
            color: #e2e8f0;
        }
        h1, h2, h3, .font-magic {
            font-family: 'Cinzel', serif;
        }
        .parchment {
            background-color: #f3e5ab;
            color: #2c1810;
        }
        /* Custom Checkbox Animation */
        .check-anim {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Data ---
        const ITINERARY_DATA = [
            {
                id: 1,
                time: "8:15 AM",
                title: "The Arrival ðŸš—",
                location: "Universal Parking Garage",
                description: "Stow your Muggle carriage in the great concrete tower. Proceed through the charms of security and venture forth towards the gates.",
                lat: 28.4738,
                lng: -81.4635,
                url: "https://www.universalorlando.com/web/en/us/plan-your-visit/hours-information/directions-and-parking",
                mapQuery: "Universal Orlando Parking Garage",
                type: "logistics"
            },
            {
                id: 2,
                time: "8:45 AM",
                title: "Gates of Magic âœ¨",
                location: "Universal Studios Florida Entrance",
                description: "Gather at the threshold! Make haste past the turnstiles and seek the hidden entrance to London's magical side.",
                lat: 28.4752, 
                lng: -81.4670,
                url: "https://www.universalorlando.com/web/en/us/theme-parks/universal-studios-florida",
                mapQuery: "Universal Studios Florida Entrance",
                type: "logistics"
            },
            {
                id: 3,
                time: "9:00 AM",
                title: "The Wand Chooses You ðŸª„",
                location: "Diagon Alley",
                description: "Witness the ancient magic at Ollivanders before the crowds descend. A truly spellbinding start for a young witch!",
                lat: 28.4800,
                lng: -81.4710,
                url: "https://www.universalorlando.com/web/en/us/things-to-do/shopping/ollivanders-diagon-alley",
                mapQuery: "Ollivanders Wand Shop Diagon Alley",
                type: "attraction"
            },
            {
                id: 4,
                time: "9:20 AM",
                title: "Secrets of the Alley ðŸ—ï¸",
                location: "Diagon Alley",
                description: "Explore the cobbles! Visit Weasleys' for mischief ðŸŽ­, gaze upon the fire-breathing dragon ðŸ‰, and cast your first spells.",
                lat: 28.4798,
                lng: -81.4708,
                url: "https://www.universalorlando.com/web/en/us/theme-parks/universal-studios-florida/the-wizarding-world-of-harry-potter-diagon-alley",
                mapQuery: "Weasleys' Wizard Wheezes Universal Studios",
                type: "explore"
            },
            {
                id: 5,
                time: "10:00 AM",
                title: "All Aboard! ðŸš‚",
                location: "King's Cross Station",
                description: "Pass through the brick wall to Platform 9Â¾. The Hogwarts Express awaits to whisk you away to the snowy village.",
                lat: 28.4794,
                lng: -81.4703,
                url: "https://www.universalorlando.com/web/en/us/things-to-do/rides-attractions/hogwarts-express",
                mapQuery: "Hogwarts Express King's Cross Station",
                type: "ride"
            },
            {
                id: 6,
                time: "10:15 AM",
                title: "Village of Snow â„ï¸",
                location: "Hogsmeade Village",
                description: "A quick wander through the snow-capped roofs. Peer into Honeydukes ðŸ¬ and spot the owls roosting overhead.",
                lat: 28.4735,
                lng: -81.4732,
                url: "https://www.universalorlando.com/web/en/us/theme-parks/islands-of-adventure/the-wizarding-world-of-harry-potter-hogsmeade",
                mapQuery: "The Wizarding World of Harry Potter - Hogsmeade",
                type: "explore"
            },
            {
                id: 7,
                time: "10:30 AM",
                title: "Flight of Fancy ðŸ¦…",
                location: "Hogsmeade",
                description: "Bow low to the Hippogriff! A spirited flight past Hagrid's hut on wicker wings.",
                lat: 28.4725,
                lng: -81.4738,
                url: "https://www.universalorlando.com/web/en/us/things-to-do/rides-attractions/flight-of-the-hippogriff",
                mapQuery: "Flight of the Hippogriff Universal Orlando",
                type: "ride"
            },
            {
                id: 8,
                time: "11:00 AM",
                title: "Into the Wilds ðŸï¸",
                location: "Hogsmeade",
                description: "Hold on tight! Careen through the Forbidden Forest on Hagrid's motorbike. Choose the sidecar for a smoother journey!",
                lat: 28.4732,
                lng: -81.4740,
                url: "https://www.universalorlando.com/web/en/us/things-to-do/rides-attractions/hagrids-magical-creatures-motorbike-adventure",
                mapQuery: "Hagrid's Magical Creatures Motorbike Adventure",
                type: "ride"
            },
            {
                id: 9,
                time: "11:35 AM",
                title: "Castle Secrets ðŸ°",
                location: "Hogwarts Castle",
                description: "Soar through the corridors of Hogwarts! Face Dementors and dragons in a thrilling flight.",
                lat: 28.4718,
                lng: -81.4745,
                url: "https://www.universalorlando.com/web/en/us/things-to-do/rides-attractions/harry-potter-and-the-forbidden-journey",
                mapQuery: "Harry Potter and the Forbidden Journey",
                type: "ride"
            },
            {
                id: 10,
                time: "12:10 PM",
                title: "Feast of Legends ðŸ—",
                location: "Hogsmeade",
                description: "Rest your weary feet at The Three Broomsticks. Sip a frothy Butterbeer ðŸº and enjoy a hearty English meal.",
                lat: 28.4730,
                lng: -81.4735,
                url: "https://www.universalorlando.com/web/en/us/things-to-do/dining/three-broomsticks",
                mapQuery: "Three Broomsticks Universal Orlando",
                type: "dining"
            },
            {
                id: 11,
                time: "12:40 PM",
                title: "Return to London ðŸ‡¬ðŸ‡§",
                location: "Hogsmeade Station",
                description: "The return journey holds new surprises! Watch the shadows in the corridor as you head back to the city.",
                lat: 28.4741,
                lng: -81.4727,
                url: "https://www.universalorlando.com/web/en/us/things-to-do/rides-attractions/hogwarts-express",
                mapQuery: "Hogwarts Express Hogsmeade Station",
                type: "ride"
            },
            {
                id: 12,
                time: "1:00 PM",
                title: "Spells & Spectacles ðŸŽ­",
                location: "Diagon Alley",
                description: "Enjoy the Tales of Beedle the Bard ðŸ“œ, listen to Celestina Warbeck, and visit the Magical Menagerie.",
                lat: 28.4797,
                lng: -81.4712, 
                url: "https://www.universalorlando.com/web/en/us/things-to-do/entertainment/celestina-warbeck-and-the-banshees",
                mapQuery: "Carkitt Market Universal Studios",
                type: "explore"
            },
            {
                id: 13,
                time: "1:40 PM",
                title: "Frozen Delights ðŸ¦",
                location: "Florean Fortescue's",
                description: "A final treat! Butterbeer ice cream is essential. Don't forget a photo with the Knight Bus ðŸšŒ!",
                lat: 28.4799,
                lng: -81.4709,
                url: "https://www.universalorlando.com/web/en/us/things-to-do/dining/florean-fortescues-ice-cream-parlour",
                mapQuery: "Florean Fortescue's Ice-Cream Parlour",
                type: "dining"
            },
            {
                id: 14,
                time: "1:55 PM",
                title: "Mischief Managed ðŸ‘£",
                location: "USF Exit",
                description: "The day is done! Exit via the London Waterfront, memories secured in your Pensieve.",
                lat: 28.4752, 
                lng: -81.4670,
                url: "https://www.universalorlando.com/web/en/us/theme-parks/universal-studios-florida",
                mapQuery: "Universal Studios Florida",
                type: "logistics"
            }
        ];

        // --- Helper: Haversine Distance & Bearing ---
        function getDistanceFromLatLonInYards(lat1, lon1, lat2, lon2) {
            var R = 6371; // Radius of the earth in km
            var dLat = deg2rad(lat2 - lat1);
            var dLon = deg2rad(lon2 - lon1);
            var a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            var d = R * c; // Distance in km
            return d * 1093.61; // Distance in yards (1 km = 1093.61 yards)
        }

        function getCardinalDirection(lat1, lng1, lat2, lng2) {
            const y = Math.sin(deg2rad(lng2 - lng1)) * Math.cos(deg2rad(lat2));
            const x = Math.cos(deg2rad(lat1)) * Math.sin(deg2rad(lat2)) -
                    Math.sin(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.cos(deg2rad(lng2 - lng1));
            const brng = Math.atan2(y, x);
            const deg = (brng * 180 / Math.PI + 360) % 360;
            
            const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
            const index = Math.round(deg / 45) % 8;
            return directions[index];
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        function formatDistanceInfo(userLoc, itemLat, itemLng) {
            const yards = getDistanceFromLatLonInYards(userLoc.lat, userLoc.lng, itemLat, itemLng);
            const direction = getCardinalDirection(userLoc.lat, userLoc.lng, itemLat, itemLng);
            
            if (yards > 1760) {
                return `${(yards / 1760).toFixed(1)} miles ${direction}`;
            }
            return `${Math.round(yards)} yds ${direction}`;
        }

        // --- Components ---

        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size }}></i>;
        };

        const ItemCard = ({ item, userLoc, isCompleted, onToggle, showDist }) => {
            const getIcon = (type) => {
                switch(type) {
                    case 'ride': return 'train-front';
                    case 'dining': return 'utensils';
                    case 'explore': return 'compass';
                    case 'attraction': return 'wand';
                    default: return 'map-pin';
                }
            };

            const colors = {
                ride: 'border-red-800 bg-red-900/10',
                dining: 'border-yellow-600 bg-yellow-900/10',
                explore: 'border-blue-800 bg-blue-900/10',
                attraction: 'border-purple-800 bg-purple-900/10',
                logistics: 'border-gray-600 bg-gray-800/20'
            };
            
            // Build the specific Google Maps Search URL
            const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.mapQuery)}`;

            return (
                <div className={`mb-4 p-4 rounded-lg border-l-4 shadow-md bg-gray-800 transition-all duration-300 ${colors[item.type] || 'border-gray-500'} ${isCompleted ? 'opacity-50 grayscale' : 'opacity-100'}`}>
                    <div className="flex justify-between items-start mb-2">
                        <div className="flex items-center gap-2 flex-1">
                            {/* Checkbox */}
                            <button 
                                onClick={() => onToggle(item.id)}
                                className={`flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center check-anim ${
                                    isCompleted 
                                    ? 'bg-green-600 border-green-600 text-white' 
                                    : 'border-gray-500 text-transparent hover:border-yellow-500'
                                }`}
                            >
                                <Icon name="check" size={14} strokeWidth={4} />
                            </button>
                            
                            <div className={isCompleted ? 'line-through decoration-gray-500' : ''}>
                                <div className="flex items-center gap-2">
                                    <Icon name={getIcon(item.type)} size={18} className={isCompleted ? 'text-gray-500' : 'text-yellow-500'} />
                                    <h3 className="font-bold text-lg font-magic leading-tight">{item.title}</h3>
                                </div>
                            </div>
                        </div>
                        <span className={`font-mono text-sm whitespace-nowrap ml-2 ${isCompleted ? 'text-gray-500' : 'text-yellow-500'}`}>{item.time}</span>
                    </div>
                    
                    <div className="pl-8">
                        <p className="text-sm text-gray-400 mb-1">{item.location}</p>
                        <p className="text-sm mb-3 italic opacity-90 font-serif text-gray-300">"{item.description}"</p>
                        
                        {showDist && userLoc && (
                            <div className="mb-3 flex items-center gap-1 text-xs text-green-400 font-bold font-mono">
                                <Icon name="navigation" size={12} />
                                {formatDistanceInfo(userLoc, item.lat, item.lng)}
                            </div>
                        )}

                        <div className="flex gap-3 mt-2">
                            <a href={item.url} target="_blank" className="flex-1 bg-gray-700 hover:bg-gray-600 text-center py-2 rounded text-sm font-semibold transition-colors flex justify-center items-center gap-2">
                                <Icon name="info" size={14} /> Official Info
                            </a>
                            <a href={mapsUrl} target="_blank" className="flex-1 bg-blue-700 hover:bg-blue-600 text-center py-2 rounded text-sm font-semibold transition-colors flex justify-center items-center gap-2">
                                <Icon name="map" size={14} /> Maps
                            </a>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('schedule');
            const [userLoc, setUserLoc] = useState(null);
            const [geoError, setGeoError] = useState(null);
            
            // Completion State with LocalStorage Persistence
            const [completedItems, setCompletedItems] = useState(() => {
                try {
                    const saved = localStorage.getItem('wizard_progress');
                    return saved ? JSON.parse(saved) : [];
                } catch (e) {
                    return [];
                }
            });

            // Save to LocalStorage whenever completed items change
            useEffect(() => {
                localStorage.setItem('wizard_progress', JSON.stringify(completedItems));
            }, [completedItems]);

            const toggleComplete = (id) => {
                setCompletedItems(prev => {
                    if (prev.includes(id)) {
                        return prev.filter(itemId => itemId !== id);
                    } else {
                        return [...prev, id];
                    }
                });
            };

            // Get Location
            const updateLocation = () => {
                if ("geolocation" in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            setUserLoc({
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            });
                            setGeoError(null);
                        },
                        (error) => {
                            console.error("Geo error:", error);
                            setGeoError("Location access needed for 'Nearby' view.");
                        },
                        { enableHighAccuracy: true }
                    );
                } else {
                    setGeoError("Geolocation not supported by this browser.");
                }
            };

            useEffect(() => {
                updateLocation();
                const interval = setInterval(updateLocation, 60000);
                return () => clearInterval(interval);
            }, []);

            // Sort Data
            const displayedItems = useMemo(() => {
                let items = [...ITINERARY_DATA];
                
                if (view === 'alphabetical') {
                    items.sort((a, b) => a.title.localeCompare(b.title));
                } else if (view === 'nearby' && userLoc) {
                    items = items.map(item => ({
                        ...item,
                        // Store numeric yards for sorting logic only
                        sortDist: getDistanceFromLatLonInYards(userLoc.lat, userLoc.lng, item.lat, item.lng)
                    })).sort((a, b) => a.sortDist - b.sortDist);
                }
                return items;
            }, [view, userLoc]);

            // Calculate Progress
            const progressPercentage = Math.round((completedItems.length / ITINERARY_DATA.length) * 100);

            return (
                <div className="min-h-screen pb-20">
                    {/* Header */}
                    <header className="bg-red-900 text-yellow-500 p-4 sticky top-0 z-50 shadow-lg border-b-4 border-yellow-600">
                        <div className="flex justify-between items-center mb-1">
                            <h1 className="text-xl font-bold tracking-wider">Potter Guide</h1>
                            <div className="text-xs font-mono bg-black/30 px-2 py-1 rounded">
                                {completedItems.length}/{ITINERARY_DATA.length} Mischiefs Managed
                            </div>
                        </div>
                        {/* Progress Bar */}
                        <div className="w-full bg-red-950 h-1.5 rounded-full overflow-hidden">
                            <div 
                                className="bg-yellow-500 h-full transition-all duration-500" 
                                style={{ width: `${progressPercentage}%` }}
                            ></div>
                        </div>
                    </header>

                    {/* View Switcher */}
                    <div className="bg-gray-900 p-2 flex gap-2 sticky top-20 z-40 shadow-md">
                        {['schedule', 'alphabetical', 'nearby'].map((v) => (
                            <button
                                key={v}
                                onClick={() => {
                                    setView(v);
                                    if(v === 'nearby' && !userLoc) updateLocation();
                                }}
                                className={`flex-1 py-2 text-sm font-bold uppercase tracking-wide rounded transition-all ${
                                    view === v 
                                    ? 'bg-yellow-600 text-gray-900 shadow-[0_0_10px_rgba(202,138,4,0.5)]' 
                                    : 'bg-gray-800 text-gray-400 hover:bg-gray-700'
                                }`}
                            >
                                {v}
                            </button>
                        ))}
                    </div>

                    {/* Content */}
                    <main className="p-4 max-w-2xl mx-auto">
                        
                        {/* Map Error Message (If nearby selected but no geo) */}
                        {view === 'nearby' && geoError && (
                            <div className="bg-red-900/50 border border-red-500 p-4 rounded text-center mb-6">
                                <p className="text-sm">{geoError}</p>
                                <button onClick={updateLocation} className="mt-2 bg-red-700 px-4 py-2 rounded text-sm font-bold">Retry Permission</button>
                            </div>
                        )}

                        {/* List */}
                        <div className="space-y-4">
                            {displayedItems.map((item) => (
                                <ItemCard 
                                    key={item.id} 
                                    item={item} 
                                    userLoc={userLoc}
                                    showDist={view === 'nearby'}
                                    isCompleted={completedItems.includes(item.id)}
                                    onToggle={toggleComplete}
                                />
                            ))}
                        </div>
                        
                        {/* Footer Spacer for mobile navs */}
                        <div className="h-10"></div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
